<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>imagine — esc</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="text-to-image" />
  <meta property="og:title" content="imagine — esc" />
  <meta property="og:description" content="text-to-image" />
  <meta property="og:image" content="https://i.imgur.com/6SpuDmE.png" />

  <link rel="icon" href="https://i.imgur.com/9GGNGm1.jpeg" type="image/jpeg" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <header class="banner">
    <img src="gachiakuta.jpg" alt="Gachiakuta Banner" draggable="false" oncontextmenu="return false;">
  </header>

  <h1 class="main-title"><span>Text</span> <span>to</span> <span>image</span></h1>
  <div id="error" class="error"></div>
  <div id="loading" class="loading" style="display:none;"><span class="loader"></span></div>
  <div class="images-layout" id="imagesLayout"></div>

  <div class="favourites-gallery">
    <div class="favourites-grid" id="favouritesGrid"></div>
  </div>

  <div class="overlay" id="overlay"><img src="" alt="Expanded"></div>

  <div class="wrapper">
    <div class="liquidGlass-wrapper">
      <div class="liquidGlass-text">
        <input id="promptInput" type="text" placeholder="Describe your imagination..." autocomplete="off" spellcheck="false" />
      </div>
    </div>
  </div>

  <script>
    const promptInput = document.getElementById("promptInput");
    const errorEl = document.getElementById("error");
    const loadingEl = document.getElementById("loading");
    const imagesLayout = document.getElementById("imagesLayout");
    const overlay = document.getElementById("overlay");
    const overlayImg = overlay.querySelector("img");
    const favouritesGrid = document.getElementById("favouritesGrid");

    let isGenerating = false;
    const favourites = new Set();
    
    promptInput.addEventListener("focus", (e) => {
      if (promptInput.value && !promptInput.dataset.selected) {
        promptInput.select();
        promptInput.dataset.selected = "true";
      }
    });

    promptInput.addEventListener("blur", () => {
      delete promptInput.dataset.selected;
    });

    promptInput.addEventListener("keydown", async (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        promptInput.blur();
        window.scrollTo({ top: 0, behavior: "smooth" });
        await generateImages();
      }
    });

    async function generateImages() {
      if (isGenerating) return;
      const prompt = promptInput.value.trim();
      if (!prompt) { errorEl.textContent = "Please enter a prompt."; return; }

      errorEl.textContent = "";
      loadingEl.style.display = "flex";
      isGenerating = true;

      try {
        const response = await fetch(`/api/imagine?prompt=${encodeURIComponent(prompt)}`);
        const data = await response.json();
        if (!response.ok) throw new Error(data.error || "Failed to generate images.");

        imagesLayout.innerHTML = "";
        const topRow = document.createElement("div");
        topRow.className = "top-row";
        for (let i = 0; i < 2; i++) topRow.appendChild(createImageCard(data.images[i], "square"));
        const bottomRow = document.createElement("div");
        bottomRow.className = "bottom-row";
        bottomRow.appendChild(createImageCard(data.images[2], "wide"));
        imagesLayout.appendChild(topRow);
        imagesLayout.appendChild(bottomRow);

        setTimeout(() => {
          imagesLayout.scrollIntoView({ behavior: "smooth", block: "start" });
        }, 300);
      } catch (err) {
        errorEl.textContent = err.message || "Error generating images.";
      } finally {
        loadingEl.style.display = "none";
        isGenerating = false;
      }
    }

    function createImageCard(src, shape) {
      const card = document.createElement("div");
      card.className = `image-card ${shape}`;
      const img = document.createElement("img");
      img.src = src;
      img.alt = "Generated image";
      img.draggable = false;
      img.addEventListener("contextmenu", e => e.preventDefault());
      img.addEventListener("click", () => openOverlay(src));
      const heart = document.createElement("i");
      heart.className = "heart-icon fa-regular fa-heart";
      heart.addEventListener("click", e => {
        e.stopPropagation();
        toggleFavourite(src, heart);
      });
      card.append(img, heart);
      return card;
    }

    function toggleFavourite(src, heart) {
      const isActive = heart.classList.toggle("active");
      heart.classList.toggle("fa-solid", isActive);
      heart.classList.toggle("fa-regular", !isActive);
      if (isActive) {
        favourites.add(src);
        addToFavourites(src);
      } else {
        favourites.delete(src);
        removeFromFavourites(src);
        syncHearts(src, false);
      }
      syncHearts(src, isActive);
    }

    function syncHearts(src, state) {
      document.querySelectorAll(`img[src='${src}']`).forEach(img => {
        const icon = img.parentElement.querySelector(".heart-icon");
        if (icon) {
          icon.classList.toggle("active", state);
          icon.classList.toggle("fa-solid", state);
          icon.classList.toggle("fa-regular", !state);
        }
      });
    }

    function addToFavourites(src) {
      if (document.querySelector(`#favouritesGrid img[src="${src}"]`)) return;
      const favCard = createImageCard(src, "small-square");
      favouritesGrid.appendChild(favCard);
    }

    function removeFromFavourites(src) {
      const card = document.querySelector(`#favouritesGrid img[src="${src}"]`)?.parentElement;
      if (card) card.remove();
    }

    function openOverlay(src) {
      overlayImg.src = src;
      overlay.classList.add("active");
    }
    overlay.addEventListener("click", () => overlay.classList.remove("active"));
    const typewriterTexts = [
      "Describe your imagination...",
      "A glowing forest under twin moons...",
      "A cyberpunk samurai in the rain...",
      "A dragon curled around a crystal tower...",

      "Unleash your imagination...",
      "A surreal dreamscape made of mirrors...",
      "A cozy cabin floating among clouds...",
      "An astronaut discovering ancient ruins on Mars...",

      "Visualize your thoughts...",
      "A neon city built inside a giant tree...",
      "A waterfall made of stars...",
      "A fox wearing a crown of fireflies...",

      "Let your creativity flow...",
      "A futuristic temple hidden in the desert...",
      "A giant whale swimming through the sky...",
      "A time traveler meeting their past self..."
    ];

    let currentTextIndex = 0;
    let charIndex = 0;
    let typingSpeed = 45;
    let deletingSpeed = 17;
    let delayBetweenTexts = 1500;

    function typeWriter() {
      const text = typewriterTexts[currentTextIndex];
      const displayText = text.substring(0, charIndex);
      promptInput.setAttribute("placeholder", displayText);

      if (charIndex < text.length) {
        charIndex++;
        setTimeout(typeWriter, typingSpeed);
      } else {
        setTimeout(deleteText, delayBetweenTexts);
      }
    }

    function deleteText() {
      const text = typewriterTexts[currentTextIndex];
      const displayText = text.substring(0, charIndex);
      promptInput.setAttribute("placeholder", displayText);

      if (charIndex > 0) {
        charIndex--;
        setTimeout(deleteText, deletingSpeed);
      } else {
        currentTextIndex = (currentTextIndex + 1) % typewriterTexts.length;
        setTimeout(typeWriter, 300);
      }
    }
        typeWriter();
  </script>
</body>
</html>